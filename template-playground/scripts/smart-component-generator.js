#!/usr/bin/env node

/**
 * Smart Component Generator
 * 
 * Analyzes extracted HTML structure and generates clean React components
 * with proper data binding - NOT direct HTML conversion
 * 
 * Usage:
 *   node scripts/smart-component-generator.js --id double-column --number 19
 */

import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
import { parse } from 'node-html-parser';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Parse command line arguments
function parseArgs() {
  const args = process.argv.slice(2);
  const options = { id: null, number: null };

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--id') options.id = args[++i];
    else if (args[i] === '--number') options.number = parseInt(args[++i]);
  }

  return options;
}

// Analyze layout structure
function analyzeLayout(root) {
  console.log(`üîç Analyzing layout structure...`);
  
  // Look for the main page wrapper
  const pageWrapper = root.querySelector('.ResumePage-module_column__lCanX') ||
                     root.querySelector('[class*="column"]');
  
  if (!pageWrapper) {
    return { type: 'single-column', columns: [] };
  }
  
  // Check grid-template-columns style
  const style = pageWrapper.getAttribute('style') || '';
  const gridMatch = style.match(/grid-template-columns:\s*([^;]+)/);
  
  if (gridMatch) {
    const gridValue = gridMatch[1];
    console.log(`Found grid-template-columns: ${gridValue}`);
    // Check if it's a two-column layout
    if (gridValue.includes('1fr') && gridValue.split('1fr').length > 2) {
      console.log(`‚úÖ Detected: Two-column grid layout`);
      return { type: 'two-column', gridValue };
    }
  }
  
  // Check for columnContainer divs (Enhancv uses these for columns)
  const columnContainers = root.querySelectorAll('.ResumePage-module_columnContainer__Hvesk');
  if (columnContainers.length >= 2) {
    console.log(`‚úÖ Detected: Two-column layout (${columnContainers.length} column containers)`);
    return { type: 'two-column', containers: columnContainers.length };
  }
  
  // Check if template name suggests two columns
  const allText = root.text || '';
  if (allText.toLowerCase().includes('double') || allText.toLowerCase().includes('deux colonnes')) {
    console.log(`‚úÖ Detected: Two-column layout (from template name)`);
    return { type: 'two-column', detected: 'by-name' };
  }
  
  return { type: 'single-column' };
}

// Extract sections and their positions
function extractSections(root) {
  console.log(`üìã Extracting sections...`);
  
  const sections = [];
  const sectionElements = root.querySelectorAll('[id*="Section-"]');
  
  for (const el of sectionElements) {
    const id = el.getAttribute('id') || '';
    const match = id.match(/(\w+)Section-(\d+)/);
    
    if (match) {
      const [, type, index] = match;
      
      // Find section name
      const nameEl = el.querySelector('[class*="sectionName"]');
      const name = nameEl?.text?.trim() || type;
      
      // Get section styles
      const sectionContainer = el.querySelector('[class*="resumeSectionContainer"]');
      const containerStyle = sectionContainer?.getAttribute('style') || '';
      
      sections.push({
        type,
        name,
        index: parseInt(index),
        id,
        styles: containerStyle,
      });
    }
  }
  
  console.log(`‚úÖ Found ${sections.length} sections:`, sections.map(s => s.type).join(', '));
  return sections;
}

// Extract color scheme
function extractColors(root) {
  console.log(`üé® Extracting color scheme...`);
  
  const colors = {
    primary: '#000000',
    accent: '#1E90FF',
    text: '#333333',
    background: '#ffffff',
  };
  
  // Look for title color
  const titleEl = root.querySelector('[data-test-id="header-title"]');
  if (titleEl) {
    const style = titleEl.getAttribute('style') || '';
    const colorMatch = style.match(/color:\s*rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
    if (colorMatch) {
      const [, r, g, b] = colorMatch;
      colors.accent = `rgb(${r}, ${g}, ${b})`;
    }
  }
  
  console.log(`‚úÖ Colors:`, colors);
  return colors;
}

// Generate clean React component
function generateComponent(templateId, templateName, templateNumber, layout, sections, colors) {
  console.log(`‚öõÔ∏è Generating clean React component...`);
  
  const componentName = templateName.replace(/[^a-zA-Z0-9]/g, '');
  
  // Determine if two-column
  const isTwoColumn = layout.type === 'two-column';
  
  let component = `/**
 * TEMPLATE ${templateNumber}: ${templateName.toUpperCase()}
 * Extracted from Enhancv
 * Layout: ${layout.type}
 * Auto-generated by smart-component-generator.js
 */

import React from 'react'
import type { UniversalTemplateProps } from './universal-schema'

export const ${componentName}Template: React.FC<UniversalTemplateProps> = ({ data }) => (
  <div style={{
    width: '850px',
    minHeight: '1200px',
    background: '${colors.background}',
    padding: '60px',
    overflow: 'hidden',
    fontFamily: "'Arial', sans-serif",
  }}>
    {/* Header */}
    <header style={{ marginBottom: '30px' }}>
      <h1 style={{
        fontSize: '36px',
        fontWeight: 700,
        color: '${colors.primary}',
        marginBottom: '8px',
        textTransform: 'uppercase',
      }}>
        {data.personal.fullName}
      </h1>
      {data.personal.title && (
        <h2 style={{
          fontSize: '18px',
          fontWeight: 400,
          color: '${colors.accent}',
          marginBottom: '16px',
        }}>
          {data.personal.title}
        </h2>
      )}
      <div style={{
        fontSize: '12px',
        color: '#666666',
        display: 'flex',
        flexWrap: 'wrap',
        gap: '16px',
      }}>
        {data.personal.email && <span>‚úâ {data.personal.email}</span>}
        {data.personal.linkedIn && <span>üîó {data.personal.linkedIn}</span>}
        {data.personal.location && <span>üìç {data.personal.location}</span>}
      </div>
    </header>

`;

  if (isTwoColumn) {
    component += `    {/* Two Column Layout */}
    <div style={{
      display: 'grid',
      gridTemplateColumns: '1fr 1fr',
      gap: '30px',
    }}>
      {/* Left Column */}
      <div>
`;
    
    // Add left column sections (Experience, Education)
    const leftSections = sections.filter(s => 
      ['Experience', 'Education', 'Course'].includes(s.type)
    );
    
    for (const section of leftSections) {
      component += generateSectionCode(section, colors, 4);
    }
    
    component += `      </div>

      {/* Right Column */}
      <div>
`;
    
    // Add right column sections (Summary, Skills, Languages, etc.)
    const rightSections = sections.filter(s => 
      !['Experience', 'Education', 'Course'].includes(s.type)
    );
    
    for (const section of rightSections) {
      component += generateSectionCode(section, colors, 4);
    }
    
    component += `      </div>
    </div>
`;
  } else {
    // Single column layout
    for (const section of sections) {
      component += generateSectionCode(section, colors, 2);
    }
  }
  
  component += `  </div>
)
`;
  
  console.log(`‚úÖ Component generated`);
  return component;
}

// Generate code for a specific section
function generateSectionCode(section, colors, indent) {
  const ind = '  '.repeat(indent);
  const type = section.type;
  
  let code = `${ind}{/* ${section.name} Section */}\n`;
  
  if (type === 'Summary') {
    code += `${ind}{data.summary && (
${ind}  <section style={{ marginBottom: '24px' }}>
${ind}    <h3 style={{
${ind}      fontSize: '16px',
${ind}      fontWeight: 700,
${ind}      color: '${colors.primary}',
${ind}      marginBottom: '12px',
${ind}      borderBottom: '3px solid ${colors.primary}',
${ind}      paddingBottom: '4px',
${ind}    }}>
${ind}      ${section.name.toUpperCase()}
${ind}    </h3>
${ind}    <p style={{ fontSize: '13px', lineHeight: 1.6, color: '${colors.text}' }}>
${ind}      {data.summary}
${ind}    </p>
${ind}  </section>
${ind})}\n\n`;
  }
  
  else if (type === 'Experience') {
    code += `${ind}{data.experience && data.experience.length > 0 && (
${ind}  <section style={{ marginBottom: '24px' }}>
${ind}    <h3 style={{
${ind}      fontSize: '16px',
${ind}      fontWeight: 700,
${ind}      color: '${colors.primary}',
${ind}      marginBottom: '12px',
${ind}      borderBottom: '3px solid ${colors.primary}',
${ind}      paddingBottom: '4px',
${ind}    }}>
${ind}      ${section.name.toUpperCase()}
${ind}    </h3>
${ind}    {data.experience.map((exp, i) => (
${ind}      <div key={i} style={{ marginBottom: '16px' }}>
${ind}        <div style={{ fontSize: '14px', fontWeight: 700, color: '${colors.primary}' }}>
${ind}          {exp.position}
${ind}        </div>
${ind}        <div style={{ fontSize: '13px', color: '${colors.accent}', marginBottom: '4px' }}>
${ind}          {exp.company}
${ind}        </div>
${ind}        {exp.description && (
${ind}          <p style={{ fontSize: '13px', lineHeight: 1.6, color: '${colors.text}' }}>
${ind}            {exp.description}
${ind}          </p>
${ind}        )}
${ind}      </div>
${ind}    ))}
${ind}  </section>
${ind})}\n\n`;
  }
  
  else if (type === 'Education') {
    code += `${ind}{data.education && data.education.length > 0 && (
${ind}  <section style={{ marginBottom: '24px' }}>
${ind}    <h3 style={{
${ind}      fontSize: '16px',
${ind}      fontWeight: 700,
${ind}      color: '${colors.primary}',
${ind}      marginBottom: '12px',
${ind}      borderBottom: '3px solid ${colors.primary}',
${ind}      paddingBottom: '4px',
${ind}    }}>
${ind}      ${section.name.toUpperCase()}
${ind}    </h3>
${ind}    {data.education.map((edu, i) => (
${ind}      <div key={i} style={{ marginBottom: '12px' }}>
${ind}        <div style={{ fontSize: '14px', fontWeight: 700, color: '${colors.primary}' }}>
${ind}          {edu.degree}
${ind}        </div>
${ind}        <div style={{ fontSize: '13px', color: '${colors.accent}' }}>
${ind}          {edu.institution}
${ind}        </div>
${ind}      </div>
${ind}    ))}
${ind}  </section>
${ind})}\n\n`;
  }
  
  else if (type === 'Technology') {
    code += `${ind}{data.skills && data.skills.length > 0 && (
${ind}  <section style={{ marginBottom: '24px' }}>
${ind}    <h3 style={{
${ind}      fontSize: '16px',
${ind}      fontWeight: 700,
${ind}      color: '${colors.primary}',
${ind}      marginBottom: '12px',
${ind}      borderBottom: '3px solid ${colors.primary}',
${ind}      paddingBottom: '4px',
${ind}    }}>
${ind}      SKILLS
${ind}    </h3>
${ind}    <div style={{ fontSize: '13px', lineHeight: 1.8, color: '${colors.text}' }}>
${ind}      {data.skills.join(' ‚Ä¢ ')}
${ind}    </div>
${ind}  </section>
${ind})}\n\n`;
  }
  
  else {
    // Generic section
    code += `${ind}<section style={{ marginBottom: '24px' }}>
${ind}  <h3 style={{
${ind}    fontSize: '16px',
${ind}    fontWeight: 700,
${ind}    color: '${colors.primary}',
${ind}    marginBottom: '12px',
${ind}    borderBottom: '3px solid ${colors.primary}',
${ind}    paddingBottom: '4px',
${ind}  }}>
${ind}    ${section.name.toUpperCase()}
${ind}  </h3>
${ind}  {/* Add content for ${type} section */}
${ind}</section>\n\n`;
  }
  
  return code;
}

// Main function
async function main() {
  const options = parseArgs();
  
  if (!options.id || !options.number) {
    console.error(`‚ùå Missing required arguments`);
    console.log(`\nUsage: node scripts/smart-component-generator.js --id <template-id> --number <template-number>`);
    process.exit(1);
  }
  
  console.log(`\nüß† Smart Component Generator`);
  console.log(`Template: ${options.id}`);
  console.log(`Number: ${options.number}\n`);
  
  try {
    // Read extracted HTML
    const htmlFile = path.join(__dirname, '..', 'extracted', `${options.id}.html`);
    const html = await fs.readFile(htmlFile, 'utf-8');
    console.log(`‚úÖ Loaded HTML: ${html.length} characters`);
    
    // Read metadata
    const metadataFile = path.join(__dirname, '..', 'extracted', `${options.id}.json`);
    const metadata = JSON.parse(await fs.readFile(metadataFile, 'utf-8'));
    const templateName = metadata.templateInfo?.name || options.id;
    
    // Parse HTML
    const root = parse(html);
    
    // Analyze structure
    const layout = analyzeLayout(root);
    const sections = extractSections(root);
    const colors = extractColors(root);
    
    // Generate component
    const component = generateComponent(
      options.id,
      templateName,
      options.number,
      layout,
      sections,
      colors
    );
    
    // Save component
    const componentFile = path.join(
      __dirname,
      '..',
      'src',
      'templates',
      `template-${options.number}-${options.id}.tsx`
    );
    await fs.writeFile(componentFile, component);
    console.log(`‚úÖ Saved component: ${componentFile}`);
    
    // Print summary
    console.log(`\n${'='.repeat(60)}`);
    console.log(`‚úÖ Generation Complete!`);
    console.log(`${'='.repeat(60)}`);
    console.log(`\nüìä Template Info:`);
    console.log(`   - Layout: ${layout.type}`);
    console.log(`   - Sections: ${sections.length}`);
    console.log(`   - Colors: ${colors.accent}`);
    console.log(`\nüìù Next steps:`);
    console.log(`   1. Refresh browser: http://localhost:3005/`);
    console.log(`   2. Select "Double Column" template`);
    console.log(`   3. Compare with original`);
    console.log();
    
  } catch (error) {
    console.error(`‚ùå Error:`, error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

// Run
main().catch(console.error);
